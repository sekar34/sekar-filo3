<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>SEKAR FİLO YÖNETİM HİZMETLERİ</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f5; color: #333; }
    header { display: flex; align-items: center; background: #006f3c; padding: 15px; justify-content: center; position:relative; }
    header h1 { color: white; margin: 0; font-size: 24px; }
    #currentUser { position:absolute; left:20px; top:20px; color:#fff; font-weight:bold; }
    .menu { text-align: center; margin: 20px; }
    .menu button { margin: 10px; padding: 12px 25px; background: #009e52; border: none; color: white; cursor: pointer; border-radius: 5px; font-size: 16px; }
    .menu button:hover { background: #007a3c; }
    .page { display: none; margin: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .login-page { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    .login-box { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.2); width: 300px; }
    .login-box h2 { margin-top: 0; text-align: center; }
    .login-box input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; }
    .login-box button { width: 100%; padding: 10px; background: #006f3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .login-box button:hover { background: #004f2a; }
    .logout-btn { position: absolute; top: 20px; right: 20px; padding: 8px 16px; background: #900; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .logout-btn:hover { background: #600; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th,td{ border:1px solid #ccc; padding:6px; text-align:center; }
    th{ background:#006f3c; color:white; }
    .edit-btn { background: orange; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; margin:2px; }
    .delete-btn { background: red; color: white; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; margin:2px; }
    .export-btn { margin-top: 10px; padding: 8px 16px; background: #006f3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .export-btn:hover { background: #004f2a; }
    .filter-row input { width: 95%; padding: 4px; font-size: 12px; }
    .red-cell { background: #ffcccc; color: #900; font-weight: bold; }
    .green-cell { background: #ccffcc; color: #060; font-weight: bold; }
    img.preview { max-width:100px; max-height:100px; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "SENIN_API_KEY",
    authDomain: "SENIN.firebaseapp.com",
    databaseURL: "https://SENIN.firebaseio.com",
    projectId: "SENIN",
    storageBucket: "SENIN.appspot.com",
    messagingSenderId: "XXXX",
    appId: "1:XXXX:web:XXXX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  </script>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-page">
  <div class="login-box">
    <h2>SEKAR FİLO GİRİŞ</h2>
    <input type="text" id="username" placeholder="Kullanıcı Adı" required>
    <input type="password" id="password" placeholder="Şifre" required>
    <button onclick="login()">Giriş Yap</button>
    <p id="loginError" style="color:red; display:none;">Hatalı giriş!</p>
  </div>
</div>

<!-- ANA SAYFA -->
<div id="mainPage" style="display:none;">
  <header>
    <span id="currentUser"></span>
    <h1>SEKAR FİLO YÖNETİM HİZMETLERİ</h1>
    <button class="logout-btn" onclick="logout()">Çıkış Yap</button>
  </header>

  <div class="menu">
    <button data-page="onay" onclick="showPage('onay')">ONAY NO</button>
  </div>

  <!-- ONAY NO -->
  <div id="onay" class="page">
    <h2>ONAY NO</h2>
    <form id="onayForm">
      Tarih: <input type="date" name="tarih" required>
      Plaka: <input name="plaka" required>
      Firma: <input type="text" name="firma">
      Km: <input type="number" name="km" required>
      Servis: <input type="text" name="servis" required>
      Durum: <select name="durum" required>
        <option value="">Seçiniz</option>
        <option>BAKIM</option><option>HASAR</option>
        <option>MEKANİK</option><option>LASTİK</option><option>DİĞER</option>
      </select>
      Açıklama: <input type="text" name="aciklama">
      Tutar: <input type="number" name="tutar" required>
      Yansıtma: <input type="text" name="yansitma">
      <button type="submit">Kaydet</button>
    </form>

    <table id="onayTable">
      <thead>
        <tr>
          <th>Onay No</th><th>Tarih</th><th>Plaka</th><th>Firma</th><th>Km</th>
          <th>Servis</th><th>Durum</th><th>Açıklama</th><th>Tutar</th><th>Fatura No</th>
          <th>Fatura Tutarı</th><th>Fark</th><th>Yansıtma</th><th>Fatura Görseli</th><th>İşlemler</th>
        </tr>
        <tr id="onayFilter" class="filter-row"></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="export-btn" onclick="exportTable('onayTable','OnayNo')">Excel'e Aktar</button>
  </div>
</div>

<script>
/* === Firebase Save/Load === */
const save = (k,d) => db.ref(k).set(d);
const load = async k => { let snap=await db.ref(k).once("value"); return snap.val()||[]; };
const fmtTL = v=>v?new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(v):"";

let onayRecords=[], onayCounter=20250000;

/* === Form Kaydet === */
document.getElementById("onayForm").onsubmit=async e=>{
  e.preventDefault();
  let f=new FormData(e.target);
  let rec={
    no:++onayCounter,
    tarih:f.get("tarih"),
    plaka:f.get("plaka").toUpperCase(),
    firma:f.get("firma").toUpperCase(),
    km:f.get("km"),
    servis:f.get("servis").toUpperCase(),
    durum:f.get("durum"),
    aciklama:f.get("aciklama")||"",
    tutar:+f.get("tutar"),
    faturaNo:"",
    faturaTutar:0,
    faturaImage:"",
    yansitma:f.get("yansitma")
  };
  onayRecords.push(rec);
  save("onayRecords",onayRecords);
  save("onayCounter",onayCounter);
  renderOnay();
  e.target.reset();
};

/* === Render Onay === */
function renderOnay(){
  let tb=document.querySelector("#onayTable tbody"); tb.innerHTML="";
  let sorted=[...onayRecords].sort((a,b)=>b.no-a.no);
  let filters=Array.from(document.querySelectorAll("#onayFilter input")).map(i=>i.value.toLowerCase());
  let headers=["no","tarih","plaka","firma","km","servis","durum","aciklama","tutar","faturaNo","faturaTutar","fark","yansitma"];
  let filtered=sorted.filter(r=>headers.every((h,idx)=>{ let val=(r[h]!==undefined?r[h]:"")+""; return val.toLowerCase().includes(filters[idx]||""); }));
  filtered.forEach((r,i)=>{
    let fark=r.faturaTutar-r.tutar;
    let farkClass=fark>50?"red-cell":(fark>0?"green-cell":"");
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.no}</td><td>${r.tarih}</td><td>${r.plaka}</td><td>${r.firma}</td>
      <td>${r.km}</td><td>${r.servis}</td><td>${r.durum}</td><td>${r.aciklama||""}</td>
      <td>${fmtTL(r.tutar)}</td><td>${r.faturaNo||""}</td>
      <td>${r.faturaTutar?fmtTL(r.faturaTutar):""}</td>
      <td class="${farkClass}">${fark?fmtTL(fark):""}</td>
      <td>${r.yansitma||""}</td>
      <td>${r.faturaImage?`<img src="${r.faturaImage}" class="preview">`:"-"}</td>
      <td>
        <button class="edit-btn" onclick="editOnay(${i})">Düzenle</button>
        <button class="delete-btn" onclick="deleteOnay(${i})">Sil</button>
        <button class="edit-btn" onclick="uploadFatura(${i})">Fatura Yükle</button>
        <button class="delete-btn" onclick="deleteFatura(${i})">Fatura Sil</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/* === Edit/Delete === */
function editOnay(i){ let r=onayRecords[i]; r.aciklama=prompt("Açıklama:",r.aciklama)||r.aciklama; save("onayRecords",onayRecords); renderOnay(); }
function deleteOnay(i){ if(confirm("Silinsin mi?")){ onayRecords.splice(i,1); save("onayRecords",onayRecords); renderOnay(); } }
function uploadFatura(i){ let input=document.createElement("input"); input.type="file"; input.onchange=e=>{let file=e.target.files[0]; if(file){let url=URL.createObjectURL(file); onayRecords[i].faturaImage=url; save("onayRecords",onayRecords); renderOnay();}}; input.click();}
function deleteFatura(i){ onayRecords[i].faturaNo=""; onayRecords[i].faturaTutar=0; onayRecords[i].faturaImage=""; save("onayRecords",onayRecords); renderOnay(); }

/* === Filtre === */
(function initOnayFilters(){ let row=document.getElementById("onayFilter"); let cols=["Onay No","Tarih","Plaka","Firma","Km","Servis","Durum","Açıklama","Tutar","Fatura No","Fatura Tutarı","Fark","Yansıtma","Fatura Görseli","İşlemler"]; row.innerHTML=""; cols.forEach(c=>{let td=document.createElement("td"); if(c!=="İşlemler"){td.innerHTML=`<input onkeyup="renderOnay()" placeholder="Filtre...">`;} row.appendChild(td);}); })();

/* === Sayfa Yüklenince === */
(async function(){
  onayRecords=await load("onayRecords");
  let counterVal=await load("onayCounter");
  if(counterVal) onayCounter=counterVal;
  renderOnay();
})();

/* === Excel Export === */
function exportTable(tid,fname){ let rows=Array.from(document.querySelectorAll(`#${tid} tr`)).map(r=>Array.from(r.cells).map(c=>c.innerText)); let csv=rows.map(r=>r.join(";")).join("\n"); let blob=new Blob([csv],{type:'text/csv'}); let link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=fname+".csv"; link.click(); }

/* === Login Basit === */
function login(){ let u=document.getElementById("username").value; let p=document.getElementById("password").value; if(u==="admin"&&p==="1234"){document.getElementById("loginPage").style.display="none";document.getElementById("mainPage").style.display="block";document.getElementById("currentUser").innerText="👤 "+u;}else{document.getElementById("loginError").style.display="block";}}
function logout(){document.getElementById("mainPage").style.display="none";document.getElementById("loginPage").style.display="flex";}
function showPage(id){document.querySelectorAll(".page").forEach(p=>p.style.display="none");document.getElementById(id).style.display="block";}
</script>
</body>
</html>
